sudo: required
language: node_js
node_js:
- 8.9
cache:
  directories:
  - node_modules
  - client/node_modules
hosts:
  - db
addons:
  ssh_known_hosts:
  - 54.206.106.116
  - 13.210.76.160
  apt:
    packages:
      - docker-ce
services:
- mysql
- docker
# env:
#   global:
#     - REGISTRY_USER=kleinchang
#     - secure: HXJ5UCTNKGXYTk9uxIO/8ujcPXs7fzcd9QWyCoTDj4XXLq86zVjPM7PNLUbnbykP5VN3xTYry0ESx+t6nEdw8LGScMBpUkEwiElTj0CWabVZ1WT6jwLnCi0nci15JaBNUHmgHe0UQWnW16fD9jkDZRom1mTVpVpSuIkkMVV1vKj3T2t2UeJO/gS2ygdC0EqCpgl4wCcorVkRzqJX17uEG+WVUFEfCnXTXVk9kqrKaZTRtLazdcVpiUpZxBXusiNNY3SA56W9AHq4jXNjJvdYuqPdwWYKeKZuQcVsTrfQ90yY/P81PhwT3GL9LU6MIDTvVUp8pQub6Az4cHt1nMGRO/opsv2kWlqi8p5wBeUdJk/Y3liZcjSIoyDExNckoxg9po/fNwkCivZxCr2cJXBdFmCdi73sLwoNM6SZKFW/l6HxqsvwXhN+LqqDB4HachBuAI2pLBfnW9KKmKJun9mJQ+yd0kISuSoXfO7RkBPUAzAVkZExLFWx+MvOOpyDJXDG+73i97qImyTsvHAomMCojcyW+SNxyDzuOWbxf3aYUreXMV71uc/hjzUXEdxXV2MM27a8w0Z+JwgieFylbS5gXFInOZPocrBHYu6ebuTwrDPzA5rgje/dGWzQflENcha3P+Gb7mPx/cEFTPzkOKKJdr688JntqLznIeetHTLQDxQ=
before_script:
- yarn db-create
- yarn db-migrate
- cd client && yarn && cd ..;
script:
- travis_wait 30 ./docker/manage.sh build prod
- docker images
- yarn test
- yarn test:frontend
- |
  if [ $TRAVIS_BRANCH == 'qa' ]; then
    cd client && REACT_APP_ENV=qa yarn build && cd ..;
  else
    cd client && yarn build && cd ..;
  fi
# - docker-compose build efc-dev
# - docker-compose up db efc-dev
# - docker-compose build efc-test
# - docker-compose up efc-test
before_deploy:
- mkdir -p ~/.ssh/key
- openssl aes-256-cbc -K $encrypted_42e0c1fefb4c_key -iv $encrypted_42e0c1fefb4c_iv
  -in deploy_rsa.enc -out ~/.ssh/key/efcsydney.pem -d
- eval "$(ssh-agent -s)"
- chmod 400 ~/.ssh/key/efcsydney.pem
#- docker login -u "$REGISTRY_USER" -p "$REGISTRY_PASS"

deploy:
- provider: script
  skip_cleanup: true
  script: sh -x deploy.sh qa #| docker push kleinchang/efcsydney-roster
  on:
    branch: qa
- provider: script
  skip_cleanup: true
  script: sh -x deploy.sh prod
  on:
    branch: master
notifications:
  slack:
    rooms:
      secure: iGVs0vWaQh/7YkhxNUHpffnry6b8xIc9AUP0/4FBb3g5qFmE2VGu6bhfDDI9apRvPtZT+tCcIcOYSe2eWI/ELZ17/3HnB02R1crifPiLU7ZETo1WwVrIqGetAGHqBJYZvSZELvVJtZMc2phoehAh8pCYScf1alvH7GmeQLW7a2Knr/kiV0WkIYjGhE8xG7sBakkCUx6V3tF0O9+6VJvEUWVKB/dEUvxMPc3Qte+9F9Mj5Tf9OEHmcWNSGaPK+xvXxqrfM/cLJQCUAajHUV0OA4A6o8W9yCRZevLaBBV+/cV6uBX+UnviwzaRZGjqlmTSlvdnaFEIN3g6W+1W3ig3BJka6ujHFwqxLa0jmFRnXGZpiaQqyeDqLcuua6OdXNtCUaVc0gigfXlNTlmZXpsbMJbuzSecK8kGk0izCWg/UYeeYmWy2SY2lpCgt5BoJbskB/7WtszQhO5+GEW9fh3sLVQsrzpoY95n8qXgUzx9ucmwhhEQKAOJyjWDpXPSMJugaEbWC0KLdgFjxOqSDXZf/++m6eD+I/kowpwkXDi1mWncNupbgUpocndmClQfGCcasZP9PIX9Fg81U+5/sWNy/gtK9Hoi6jqUFE+REBXohPAjwUIKVwrfxjm+PqAWkegmmCqyT2JDeXYIxLtnqFRY7lRWc/OpU059l0S0AsNKu14=
