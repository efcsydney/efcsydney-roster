language: node_js
node_js:
- 8.9
cache:
  directories:
  - node_modules
  - client/node_modules
hosts:
- db
addons:
  ssh_known_hosts:
  - 54.206.106.116
  - 13.210.76.160
  apt:
    packages:
    - docker-ce
services:
- mysql
- docker
env:
  global:
  - REGISTRY_USER=kleinchang
  - secure: Mu010l75I6ucSpaSbpE2cYZLanDAZR5WxdI/2TPLuquFmF8kl/ojBYw8xZIvJmdWFhb6mHTgzl7PpY4zd0mbmhpwzAbLmn+ZCBm1d5JLfN9KMeMk9HKR7r+qYiauFBEtiuwwbD5aanH1l03ZgaPVYuFWP0O0fzfNoN+356G2cgHtrKBKFEMEvyvDjsVr03tAQotnxHsrnf1afrzKIS0kFWSlP2GleZoGyT5BLbn8Y1VHgNPK7NTv3oToyyt60Ykfj4z4vPyHVtClNuVrAMBdyOd+NEsUs0FSEKHN/W+9zdYJBDO3JFCgzszMuniFwDHBpBYq25i9r3OhizjdGsNCzVe9Z7VNBzQACBu3Ni5IMc4+hGpZ2l+S31l+6DNaNv8AMDIJnRuUKhGtd4pF0j+4MFVABft7EUJgZI0FV84DEZVDBAMssDnPpADcxxGGLXVJtes9gPU4dU+nRrLd49NcgRGvK3hRhCRkmxKHGJgOFpt2ObCkeD6UfXXejA0fHCByNWRT63XKFHLESnVMRDiWNL08aUIW99MkLl43L0OzHYkhF9p0XwS7GD2/EwAyFwJVa+ctiPUN6JdROGBHhABMz+kZXpF7Cn134ei/lXkNq09eo3s4Pj63zNXvfV70ux8opeITN8XIdD+7vqsgyia1k5HJW5VupApyNGkx4jxPTtY=
  - secure: EKb7U5/vxFnlswlLHqT+L2KB2lr99aWJQydwqLabkLjzUUCYBZDH19SZZs0torUE+UJTvyDGO7wsjvRleYsS/mmKnUa0TE4i9oGo1qwt7sNfRHU42mYuNTNmTPQLOLzay2HWIqCMoTuRbDceFBHx9HGKBddfdb0O+YwGHF5qw38h6hAm5JhXCPARs4lVyQUUrik+73y5NWVegYldT7PSNrcwGZX6irFfw2kmKQrFHkCtiWjvaM1NUe82lBa62Iw3WTdNhAMh4tjTGxZbuQKrx2IcW/fPSeJQUe0FY9+kQlctlimlCbCMvG9gY5EBhEM91fFT+4TW2yHjj+x7HCgiEC6MR+kX8FLBiBoQpKHaMJU/AQBJipvV1/7lI38AJeLkScP40jzuDSNwhX4BM+X/j9aCX4Y0EKzIB9+uGw1/d9vOrdd1ht/fktHxQXCN+BIekRlF99OKFYrybCcU629ChfWbQ0Osgl9etTAqUI8H8wCGetTLSE09Ho51+uGeCbYdp7NV/n+ov1xYMdMNStqQyx9rjzJ8e8HfGdMwP/wVCPhojhlMEYKekG6lA2442cVtH/xfYz8whLjwIyEpIfI+EAN2ku5h6DWkx1RYZBKsRtdpyzmYz2RlNMCMHsXjWhFd2H6xPbXdA5PXg6g3M+91jVWUMokxDsx1QqfWbt3YCAQ=
  - secure: zHkD4Jjt4i1iNio0xW4PBicBXw6i5OC7u8zWdYTyfsbC+B1mnwSv+Dk/irkojxdtWHMYkA/B5TCM522qXeHMhO6Sl7KIrgn+0YJxJjLpMbxIw5fYbw3CZNjw0ExV5UoLDUP832S3AgY2Voqcgoq6RvtHvREWd4D8ok/GKW/B+sjgDyt9PfQBwlvScronYvrkgUYEw7ddeltlA2ZzhMqfLRvQX7tcepW7F5V8WXzvabk7n0D6yjaIIZ7lJAMd7qticaUmNMSoIN0BgYfxdvm/sbT/5MG0rSTpyYC/OX3dGpb16E+ayTnyf5pR0mBk2aUCw6OrgY7aR+z8cqo6t4fkjFVnjZvyffUxyX6fYj4LJuhep2iSwq1PwQwrE/3SsQugojtOrF06Y4cB/WoYsyz7BcWnhr6asBlfAZE2v0gQzbfT5ISvUNUAYbJRkn/fVDAThWGtmdxhEvyzctf9tD2knwiyumbaxLr1lII7V6bigZHLZfywZ92wor7ZFlcwixojG4M6f9kLG8WTsBermD00rjoFJTYINU0eWFqEFCBPCCy4i4IUvQzlFgnUsmzGfFTp6uLLgTGCQsb2ag8zekzr7uAXEGPdD9HWMxm/dj7b6GLIza/AWk0xvwhQdGAia2Y3nzLGtUIC6ZlK9ZyxvoE698yifpvBk/ysitCHEKY6ulk=
  - secure: W1tZ11YuQDiHRhDMvbnfhHuw1Pnu0kyWOcgAI4qCnWplDBmx0kO6kMpXI17F6aGN+gao4sxW3hg4BgTtqhFHs5IS3T+ZQx8MtkOdVe9R241BimR2mRCHUipZ4e87yeEAKNdiU9CGiJ3xF+XTjtBMILvQVXSZfuq5eDUff5h8oR6OXsWut6Hx/62kuPyCOTQHIBh0jFec3hI0xB/dkMzVXnH0L6yoF44QISVlnAWp/ySFw3wGEZn2/rvzw/mVE2czsVdR4Xfd5WmU5U3yMWMS93Gt78M2Q0NuNCIz5CwiKfjcLe8nYdzWxLcAnAP0/cjTGt/IFjXi2lLANOGcCB4BG1kzCaRwtavzBelImHsmwImPbkTRoQwplysw4YyPAGgLFVqPCsvleTId3O+QJJQWE8yjZp8B0qJuIZuBXAxaA2KIKvusEC+Cr9qlyiTc0XA63ngSXI+7hla3D7zNQD7kAXQmN7KqpetRkF0SCY4XcpR7HtRJnuD5iFq4oMI4U/dNeJUenCFZAPZy4/cnChNnrSWAMz/8kmt3LVohIuuNwNpOYacSanc4kNSRCIqNrdx8kGKNo7gqZEDJaI8TRGPi9KW42KUKIA16aIHaj0J6nb1D3DjUcT62nEafN7JuBIHUZqLvZsCqI6lbYHXdskngygcs+L0LsYXQTfPVfPqZyWc= #PROD_AWS_ACCESS_KEY_ID
  - secure: AstWTIKiaDtmPenWWI+Og1y3qLnfq3RHLJ/Fl3oWQQmD5WEF4HxPuiFuyw87V62jIWynZZMuLtUDTD6Y6VgLA9Qo2jbyslEt/s0bP3EwzzbR4uD60Vj36bBbZZ15rZ/i2a9W+y4E/ohi2IGBU8+nu8qQeXeTtA+k+ggXIzDVpTvYeSIHerR/ifM2tm1SGMvcR3WiFRu3V08aojpLtemIKlXYOR97YdeoWLUnUP4jE8YQpJFggDgq7AZpaGNTZifdR6w+ujrbLHDm0qyNxVzMWg2lswDsbYuLQVuTgouKJ6lR+LuTcNErs1vzLmz2ZJujipCTs0Ml1h5igtNiJc23mV/GuHhppE2kb+YA8dl3+d7w1uA9UrJVG4S0JHpr1sCAlyIdSOtDBJ5P8m1NyHPEmWHOaW0e+ln6xFBktOO48mIeEykIeGk2o+RzU1aiSe7iIhzxzLBHGi5aWFz2lWS42y5cw0h6yjcEWnQkIjYLNQlklvthZMMXKiYRv9CSAZg6gy4us0AEW5+EFHEspUc5yZZuLwQ7Deo0AOwrCZGzPADWrM0OBjzxVN5MfeXR83zpIYoq80sUtFGEc+ugLl/V4A2Q85YBd6r0k+SwO8PKYVt45e4jBFKnwl6kNG9nXDZGdOWZ0I1DLAIiWSvON4I0QAr7rer9Zp1r1Jaf9+efKQo= #PROD_AWS_SECRET_ACCESS_KEY
before_script:
- yarn db-create
- yarn db-migrate
- cd client && yarn && cd ..;
script:
- yarn test
- yarn test:frontend
- |
  if [ $TRAVIS_BRANCH == 'qa' ]; then
    cd client && REACT_APP_ENV=qa yarn build && cd ..;
  else
    cd client && yarn build && cd ..;
  fi
# - docker-compose -f docker/docker-compose.yml build efc-prod
before_deploy:
- mkdir -p ~/.ssh/key
- openssl aes-256-cbc -K $encrypted_42e0c1fefb4c_key -iv $encrypted_42e0c1fefb4c_iv
  -in deploy_rsa.enc -out ~/.ssh/key/efcsydney.pem -d
- eval "$(ssh-agent -s)"
- chmod 400 ~/.ssh/key/efcsydney.pem
- pip install --user awscli
- docker login -u "$REGISTRY_USER" -p "$REGISTRY_PASS"
deploy:
- provider: script
  skip_cleanup: true
  script: BUILD_TAG=$TRAVIS_BUILD_NUMBER\_${TRAVIS_COMMIT:0:7}
    AWS_ACCESS_KEY_ID=$QA_AWS_ACCESS_KEY_ID
    AWS_SECRET_ACCESS_KEY=$QA_AWS_SECRET_ACCESS_KEY
    sh -x docker_deploy.sh qa
  on:
    branch: qa
- provider: script
  skip_cleanup: true
  script: BUILD_TAG=$TRAVIS_BUILD_NUMBER\_${TRAVIS_COMMIT:0:7}
    AWS_ACCESS_KEY_ID=$PROD_AWS_ACCESS_KEY_ID
    AWS_SECRET_ACCESS_KEY=$PROD_AWS_SECRET_ACCESS_KEY
    sh -x docker_deploy.sh prod
  on:
    branch: master
notifications:
  slack:
    rooms:
      secure: iGVs0vWaQh/7YkhxNUHpffnry6b8xIc9AUP0/4FBb3g5qFmE2VGu6bhfDDI9apRvPtZT+tCcIcOYSe2eWI/ELZ17/3HnB02R1crifPiLU7ZETo1WwVrIqGetAGHqBJYZvSZELvVJtZMc2phoehAh8pCYScf1alvH7GmeQLW7a2Knr/kiV0WkIYjGhE8xG7sBakkCUx6V3tF0O9+6VJvEUWVKB/dEUvxMPc3Qte+9F9Mj5Tf9OEHmcWNSGaPK+xvXxqrfM/cLJQCUAajHUV0OA4A6o8W9yCRZevLaBBV+/cV6uBX+UnviwzaRZGjqlmTSlvdnaFEIN3g6W+1W3ig3BJka6ujHFwqxLa0jmFRnXGZpiaQqyeDqLcuua6OdXNtCUaVc0gigfXlNTlmZXpsbMJbuzSecK8kGk0izCWg/UYeeYmWy2SY2lpCgt5BoJbskB/7WtszQhO5+GEW9fh3sLVQsrzpoY95n8qXgUzx9ucmwhhEQKAOJyjWDpXPSMJugaEbWC0KLdgFjxOqSDXZf/++m6eD+I/kowpwkXDi1mWncNupbgUpocndmClQfGCcasZP9PIX9Fg81U+5/sWNy/gtK9Hoi6jqUFE+REBXohPAjwUIKVwrfxjm+PqAWkegmmCqyT2JDeXYIxLtnqFRY7lRWc/OpU059l0S0AsNKu14=
